name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Run tests
        run: go test -v -race ./...

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Build linux/amd64
        env:
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -ldflags "-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -o bin/vito-root-service-linux-amd64 ./cmd/vito-root-service

      - name: Build linux/arm64
        env:
          GOOS: linux
          GOARCH: arm64
        run: |
          go build -ldflags "-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -o bin/vito-root-service-linux-arm64 ./cmd/vito-root-service

      - name: Package amd64
        run: |
          tar czf vito-root-service-linux-amd64.tar.gz \
            -C bin vito-root-service-linux-amd64 \
            --transform='s/vito-root-service-linux-amd64/vito-root-service/' \
            -C "$GITHUB_WORKSPACE" \
            systemd/vito-root.socket \
            systemd/vito-root.service \
            scripts/install.sh \
            scripts/uninstall.sh

      - name: Package arm64
        run: |
          tar czf vito-root-service-linux-arm64.tar.gz \
            -C bin vito-root-service-linux-arm64 \
            --transform='s/vito-root-service-linux-arm64/vito-root-service/' \
            -C "$GITHUB_WORKSPACE" \
            systemd/vito-root.socket \
            systemd/vito-root.service \
            scripts/install.sh \
            scripts/uninstall.sh

      - name: Generate checksums
        run: |
          sha256sum vito-root-service-*.tar.gz > checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            vito-root-service-*.tar.gz
            checksums.txt
          generate_release_notes: true
